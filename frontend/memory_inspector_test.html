<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Inspector v2.0 - Test Page</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Memory Inspector CSS -->
    <link rel="stylesheet" href="css/memory_inspector.css">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .test-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .test-header {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .selector-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
        }

        .selector-box label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .selector-box select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .selector-box select:hover {
            border-color: #3B82F6;
        }

        .selector-box select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .load-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            border: none;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .load-btn:active {
            transform: translateY(0);
        }

        .load-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <!-- Test Header -->
        <div class="test-header">
            <h1 style="font-size: 2rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">
                ðŸ§  Memory Inspector v2.0
            </h1>
            <p style="color: #64748b; font-size: 1rem;">
                Real-time visualization of HARV's 5-layer memory architecture
            </p>

            <!-- Selector Grid -->
            <div class="selector-grid" style="margin-top: 2rem;">
                <div class="selector-box">
                    <label for="inspector-class-select">Class</label>
                    <select id="inspector-class-select">
                        <option value="">Select a class...</option>
                    </select>
                </div>

                <div class="selector-box">
                    <label for="inspector-module-select">Module</label>
                    <select id="inspector-module-select" disabled>
                        <option value="">Select a module...</option>
                    </select>
                </div>

                <div class="selector-box">
                    <label for="inspector-student-select">Student</label>
                    <select id="inspector-student-select" disabled>
                        <option value="">Select a student...</option>
                    </select>
                </div>

                <div class="selector-box">
                    <label for="inspector-conversation-select">Conversation (Optional)</label>
                    <select id="inspector-conversation-select" disabled>
                        <option value="">No filter (all conversations)</option>
                    </select>
                </div>
            </div>

            <!-- Load Button -->
            <div style="text-align: center; margin-top: 1.5rem;">
                <button id="load-memory-btn" class="load-btn" disabled>
                    Load Memory System
                </button>
            </div>
        </div>

        <!-- Memory Inspector Container -->
        <div id="memory-inspector-v2-container">
            <!-- Context Metrics Section -->
            <div id="context-metrics-container" style="display: none;">
                <!-- Rendered by renderContextMetrics() -->
            </div>

            <!-- Memory Layers Section -->
            <div id="memory-layers-container" style="display: none;">
                <!-- Rendered by renderMemoryDisplay() -->
            </div>

            <!-- Assembled Prompt Section -->
            <div id="assembled-prompt-container" style="display: none;">
                <!-- Rendered by renderAssembledPrompt() -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // API Configuration
        const API_BASE = 'http://localhost:8000';

        // Auth Headers (optional - most endpoints don't require auth)
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            const headers = {
                'Content-Type': 'application/json'
            };

            // Only add Authorization header if token exists
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            return headers;
        }

        // Load classes from backend
        async function loadClasses() {
            try {
                console.log('[DEBUG] Fetching classes from:', `${API_BASE}/classes`);
                const response = await fetch(`${API_BASE}/classes`, {
                    headers: getAuthHeaders()
                });

                console.log('[DEBUG] Classes response status:', response.status);

                if (!response.ok) {
                    throw new Error(`Failed to load classes: ${response.status} ${response.statusText}`);
                }

                const classes = await response.json();
                console.log('[DEBUG] Classes loaded:', classes.length, 'classes');

                const select = document.getElementById('inspector-class-select');
                select.innerHTML = '<option value="">Select a class...</option>';

                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.title || cls.name;
                    select.appendChild(option);
                });

                console.log('[SUCCESS] Classes loaded into dropdown');
            } catch (error) {
                console.error('[ERROR] Loading classes failed:', error);
                const select = document.getElementById('inspector-class-select');
                select.innerHTML = '<option value="">Error loading classes</option>';

                // Show user-friendly error
                setTimeout(() => {
                    alert(`âš ï¸ Failed to load classes.\n\nError: ${error.message}\n\nMake sure:\n1. Backend is running on http://localhost:8000\n2. You can access http://localhost:8000/classes\n3. Check browser console for details`);
                }, 500);
            }
        }

        async function loadModules(classId) {
            try {
                console.log('[DEBUG] Fetching modules for class:', classId);
                const response = await fetch(`${API_BASE}/modules`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`Failed to load modules: ${response.status}`);
                }

                const data = await response.json();
                const allModules = data.modules || data || [];

                // Filter modules by class_id
                const modules = allModules.filter(mod => mod.class_id === parseInt(classId));
                console.log('[DEBUG] Modules for class', classId, ':', modules.length);

                const select = document.getElementById('inspector-module-select');
                select.innerHTML = '<option value="">Select a module...</option>';

                modules.forEach(mod => {
                    const option = document.createElement('option');
                    option.value = mod.id;
                    option.textContent = mod.title || mod.name;
                    select.appendChild(option);
                });

                select.disabled = false;
                console.log('[SUCCESS] Modules loaded:', modules.length);
            } catch (error) {
                console.error('[ERROR] Loading modules failed:', error);
            }
        }

        async function loadStudents() {
            try {
                console.log('[DEBUG] Fetching students');
                const response = await fetch(`${API_BASE}/users`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`Failed to load students: ${response.status}`);
                }

                const data = await response.json();
                const allUsers = data.users || data || [];
                console.log('[DEBUG] Total users:', allUsers.length);

                const select = document.getElementById('inspector-student-select');
                select.innerHTML = '<option value="">Select a student...</option>';

                // Filter to only students (not admins)
                const students = allUsers.filter(u => !u.is_admin && u.role === 'student');
                console.log('[DEBUG] Students found:', students.length);

                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });

                select.disabled = false;
                console.log('[SUCCESS] Students loaded:', students.length);
            } catch (error) {
                console.error('[ERROR] Loading students failed:', error);
            }
        }

        async function loadConversations(moduleId, userId) {
            try {
                console.log('[DEBUG] Fetching conversations for module:', moduleId, 'user:', userId);
                const response = await fetch(`${API_BASE}/conversations?module_id=${moduleId}&user_id=${userId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`Failed to load conversations: ${response.status}`);
                }

                const data = await response.json();
                const conversations = data.conversations || data || [];
                console.log('[DEBUG] Conversations found:', conversations.length);

                const select = document.getElementById('inspector-conversation-select');
                select.innerHTML = '<option value="">No filter (all conversations)</option>';

                conversations.forEach(conv => {
                    const option = document.createElement('option');
                    option.value = conv.id;
                    const date = conv.created_at ? new Date(conv.created_at).toLocaleDateString() : 'Unknown date';
                    option.textContent = `Conversation ${conv.id} - ${date}`;
                    select.appendChild(option);
                });

                select.disabled = false;
                console.log('[SUCCESS] Conversations loaded:', conversations.length);
            } catch (error) {
                console.error('[ERROR] Loading conversations failed:', error);
            }
        }

        // Event Listeners
        document.getElementById('inspector-class-select').addEventListener('change', async (e) => {
            const classId = e.target.value;

            if (classId) {
                await loadModules(classId);
                await loadStudents();
            } else {
                document.getElementById('inspector-module-select').disabled = true;
                document.getElementById('inspector-student-select').disabled = true;
                document.getElementById('inspector-conversation-select').disabled = true;
                document.getElementById('load-memory-btn').disabled = true;
            }
        });

        document.getElementById('inspector-module-select').addEventListener('change', async (e) => {
            const moduleId = e.target.value;
            const userId = document.getElementById('inspector-student-select').value;

            if (moduleId && userId) {
                await loadConversations(moduleId, userId);
                document.getElementById('load-memory-btn').disabled = false;
            } else {
                document.getElementById('load-memory-btn').disabled = true;
            }
        });

        document.getElementById('inspector-student-select').addEventListener('change', async (e) => {
            const userId = e.target.value;
            const moduleId = document.getElementById('inspector-module-select').value;

            if (moduleId && userId) {
                await loadConversations(moduleId, userId);
                document.getElementById('load-memory-btn').disabled = false;
            } else {
                document.getElementById('load-memory-btn').disabled = true;
            }
        });

        document.getElementById('load-memory-btn').addEventListener('click', async () => {
            const moduleId = document.getElementById('inspector-module-select').value;
            const userId = document.getElementById('inspector-student-select').value;
            const conversationId = document.getElementById('inspector-conversation-select').value || null;

            if (!moduleId || !userId) {
                alert('Please select both a module and a student');
                return;
            }

            // Initialize Memory Inspector
            if (window.memoryInspector) {
                window.memoryInspector.selectModule(moduleId);
                window.memoryInspector.selectStudent(userId);
                if (conversationId) {
                    window.memoryInspector.selectConversation(conversationId);
                }
                await window.memoryInspector.loadMemoryData();
            } else {
                console.error('MemoryInspectorV2 not initialized');
            }
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadClasses();
        });
    </script>

    <!-- Memory Inspector v2.0 -->
    <script src="js/memory_inspector_v2.js"></script>
    <script>
        // Initialize Memory Inspector
        window.memoryInspector = new MemoryInspectorV2();
    </script>
</body>
</html>
